{% extends "layout.html" %}
{% block content %}
<div class="d-flex align-items-center mb-4">
  <h3 class="fw-bold display-6 mb-0">ðŸ“Š Dashboard</h3>
  <div class="ms-auto text-end">
    <div class="fs-5 fw-medium text-muted">
      {{ day_str }}, {{ date_str }}
    </div>
    <div class="fs-5 fw-semibold text-primary" id="liveTime">{{ time_str }}</div>
  </div>
</div>


<div class="row g-3 mb-4 text-center">
  {% set cards = [
    {'icon':'ðŸ“¦','title':'Products','value':total_products,'color':'text-dark'},
    {'icon':'ðŸ’°','title':'Stock Value','value':'à§³ '+'%.0f'|format(total_stock_value),'color':'text-primary'},
    {'icon':'ðŸ“ˆ','title':'Revenue','value':'à§³ '+'%.0f'|format(total_revenue),'color':'text-success','change':rev_change},
    {'icon':'ðŸ’¹','title':'Profit','value':'à§³ '+'%.0f'|format(total_profit),'color':'text-warning','change':profit_change}
  ] %}
  {% for c in cards %}
  <div class="col-md-3">
    <div class="card kpi shadow-sm p-3 h-100 d-flex flex-column justify-content-center">
      <div class="fs-3">{{ c.icon }}</div>
      <h6 class="text-muted">{{ c.title }}</h6>
      <h3 class="fw-bold {{ c.color }}">{{ c.value }}</h3>
      {% if c.change is defined %}
      <small class="{{ 'text-success' if c.change>=0 else 'text-danger' }}">
        {% if c.change>=0 %}â–²{% else %}â–¼{% endif %} {{ c.change }}% vs yesterday
      </small>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<div class="row g-3">
  <!-- Left Column -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white fw-semibold">Revenue Trend (Last 7 Days)</div>
      <div class="card-body"><canvas id="trendChart" height="100"></canvas></div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Top Selling Products</div>
      <div class="card-body"><canvas id="topChart" height="120"></canvas></div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="col-md-4">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white fw-semibold">Low Stock Alerts</div>
      <ul class="list-group list-group-flush">
        {% for p in low_stock %}
        <li class="list-group-item d-flex justify-content-between">
          {{ p['name'] }} <span class="badge bg-danger">{{ p['stock'] }} left</span>
        </li>
        {% else %}
        <li class="list-group-item text-muted text-center">All stocks healthy âœ…</li>
        {% endfor %}
      </ul>
    </div>

<div class="card shadow-sm">
  <div class="card-header bg-white fw-semibold">Recent Transactions</div>
  <ul class="list-group list-group-flush">
    {% for r in recent %}
    <li class="list-group-item d-flex justify-content-between align-items-center clickable-transaction"
        onclick="window.location='/bill/{{ r['id'] }}'">
      <span class="fw-semibold">#{{ r['id'] }}</span>
      <span class="fw-bold text-success">à§³ {{ '%.0f'|format(r['total_amount']) }}</span>
      <small class="text-muted">{{ r['date'].split(' ')[1] }}</small>
    </li>
    {% else %}
    <li class="list-group-item text-center text-muted">No sales yet</li>
    {% endfor %}
  </ul>
</div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function updateTime(){
  document.getElementById('liveTime').textContent = new Date().toLocaleTimeString('en-US',{hour12:true});
}
setInterval(updateTime,1000);

// Revenue trend
const trendCtx=document.getElementById('trendChart');
new Chart(trendCtx,{type:'line',
  data:{
    labels:[{% for t in trend %}'{{ t['d'] }}',{% endfor %}],
    datasets:[{label:'Revenue (à§³)',data:[{% for t in trend %}{{ t['amt'] }},{% endfor %}],
      borderColor:'#0d6efd',backgroundColor:'rgba(13,110,253,0.2)',fill:true,tension:.3}]
  },
  options:{plugins:{legend:{display:false}}}
});

// Top Selling
const topCtx=document.getElementById('topChart');
new Chart(topCtx,{type:'bar',
  data:{
    labels:[{% for n,q in top_products %}'{{ n }}',{% endfor %}],
    datasets:[{label:'Qty Sold',data:[{% for n,q in top_products %}{{ q }},{% endfor %}],
      backgroundColor:'#198754'}]
  },
  options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
});
</script>
{% endblock %}
